<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>List that makeBelief train</title>
  <!-- Bootswatch Styling for Improving the Aesthetics -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.6/flatly/bootstrap.min.css">

  <!-- Font Awesome CSS Icons (For cool glyphicons) -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <!-- Style to fix the issue of text extending past panel length -->
  <style>
    .panel-body a {
      word-break: break-all;
    }
  </style>
</head>

<body>


  <div class="container">


    <div class="jumbotron" style="background-color: rgb(27, 30, 36) ; color: white;">
      <h1 class="text-center"><strong><i class="fa fa-newspaper-o"></i> Train Times</strong></h1>
    </div>

    <div class="row">
      <div class="col-xs-12">
        <div class="panel panel-primary">
    <!-- Default panel contents -->
    <div class="panel-heading"><strong>Train Times</strong></div>
  
    <!-- Table -->
    <table class="table">
      <tr>
      <td>
        <p><strong>Train</strong></p>
      </td>
      <td>
        <p><strong>Destination</strong></p>
      </td>
       <td>
        <p><strong>Frequency (min)</strong></p>
      </td>
       <td>
        <p><strong>Next Departure</strong></p>
      </td>
      <td>
        <p><strong>Min Away</strong></p>
      </td>
  </tr>

    </table>
      </div>
        </div>
          </div>

    <div class="row">
        <div class="col-sm-12">
          <br>
          <!-- First panel is for handling the search parameters -->
          <div class="panel panel-primary">
            <div class="panel-heading">
              <h3 class="panel-title"><strong><i class="addAtrain"></i>   Add A Train</strong></h3>
            </div>
            <div class="panel-body">
  
              <form role="form">
  
                <div class="form-group">
                  <label for="search">Train Name</label>
                  <input type="text" class="form-control" id="addTrainName">
                </div>
  
             
                <div class="form-group">
                  <label for="pwd">Destination</label>
                  <input type="text" class="form-control" id="addTrainDestination">
              
                </div>
  
         
                <div class="form-group">
                  <label for="start-year">First Train Time (HH:MM)</label>
                  <input type="text" class="form-control" id="addTrainFirstTrainTime">
                </div>
  
              
                <div class="form-group">
                  <label for="end-year">Frequency (min)</label>
                  <input type="text" class="form-control" id="addTrainFrequency">
                </div>
  
                <!-- Here we have our final submit button -->
                <button type="submit" class="btn btn-default" id="addTrain"><i class="fa fa-search"></i> Submit</button>
  
              </form>
            </div>
          </div>
        </div>
      </div>

    <!-- Footer Region -->
    <div class="row">
      <div class="col-sm-12">

        <!-- Line Break followed by closing -->
        <hr>
        <h5 class="text-center"><small>Made by P</h5>

      </div>
    </div>

  </div>

  <!-- jQuery JS -->
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="https://momentjs.com/downloads/moment.js"></script>

  <script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
  
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyAnAP9acxLNrRmU966m0hiDJtHO0rdCf3w",
      authDomain: "project-p-6edcd.firebaseapp.com",
      databaseURL: "https://project-p-6edcd.firebaseio.com",
      projectId: "project-p-6edcd",
      storageBucket: "project-p-6edcd.appspot.com",
      messagingSenderId: "430948400767"
    };
    firebase.initializeApp(config);

    var database = firebase.database();

    // Initial Variables (SET the first set IN FIREBASE FIRST)
    // Note remember to create these same variables in Firebase!
    var trainName = "";
    var trainDestination = "";
    var trainTime1 = 0;
    var trainTime2 = 0;
    
    // Click Button changes what is stored in firebase
    $("#addTrain").on("click", function() {
      // Prevent the page from refreshing
      event.preventDefault();

      // Change what is saved in firebase
      database.ref().push({
        trainName: $("#addTrainName").val(),
        trainDestination: $("#addTrainDestination").val(),
        trainTime2: $("#addTrainFrequency").val(),
        trainTime1: $("#addTrainFirstTrainTime").val(),
        
      });
    });

    // Firebase is always watching for changes to the data.
    // When changes occurs it will print them to console and html
    database.ref().on('child_added', function(snapshot) {

      var td1 = $("<td>");
      td1.attr("id", "tdtrainName");
      
      var td2 = $("<td>");
      td2.attr("id", "tdtrainDestination");
      
      var td3 = $("<td>");
      td3.attr("id", "tdtrainTime2");
      
      var td4 = $("<td>");
      td4.attr("id", "tdtrainTime1");
      
      var td5 = $("<td>");
      td5.attr("id", "tdtrainMinLeft");
    
      // Change the HTML

      console.log(snapshot.val().trainName);
      console.log(snapshot.val().trainDestination);
      console.log(snapshot.val().trainTime2);
      console.log(snapshot.val().trainTime1);
    
      var trs = $("<tr>");
      var timeNow = moment().format('HH:mm:ss');
      
      
      

     
      // Time for first train, minus current time. Take the result and divide by frequency. Round that number up to have next departure. That time minus current time is time left.
      

      console.log(timeNow);
    
      
    var a = timeNow.split(':'); // split it at the colons
    var secondsNow = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);  
    
    console.log(a);
    

    
    console.log(secondsNow);

    var b = snapshot.val().trainTime1.split(':')

    var secondsTrain = ((+b[0]) * 60 * 60 + (+b[1]) * 60);  

    console.log();
    console.log(secondsTrain);

    var nextTrain = Math.abs(secondsNow-secondsTrain) 

    console.log(nextTrain);
    
    // / ((snapshot.val().trainTime2) * 60)

    var minToNextTrain = (nextTrain/((snapshot.val().trainTime2)*60));

    console.log(minToNextTrain);

    var nextTrainT = Math.ceil(minToNextTrain);

    console.log(nextTrainT);

    var mNextTrain = (nextTrainT * ((snapshot.val().trainTime2)))

    console.log(mNextTrain);

    var trainF = (mNextTrain * 60) + (secondsTrain);

    console.log(trainF);

    var minLeftTrain = ((trainF - secondsNow)/ 60);

    console.log(minLeftTrain);

    var nextTrainTrue = Math.ceil(Math.abs(minLeftTrain));

    console.log(nextTrainTrue);

    var nextTrainHHMM = moment().startOf('day')
                                .seconds(trainF)
                                .format('HH:mm:ss');

    console.log(nextTrainHHMM);

    td1.append(snapshot.val().trainName);
      td2.append(snapshot.val().trainDestination);
      td3.append(snapshot.val().trainTime2);
      td4.append(nextTrainHHMM);
      td5.append(nextTrainTrue);
      trs.append(td1, td2, td3, td4, td5);

      
      $(".table").append(trs);
    

    }, function(errorObject) {
      console.log("The read failed: " + errorObject.code);
    });

  </script>

</body>

</html>
